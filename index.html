<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>nhk_news</title>
</head>
<body>
    <div id="app"></div>
    <script>
        if (!Element.prototype.matches)
                Element.prototype.matches = Element.prototype.msMatchesSelector ||
                    Element.prototype.webkitMatchesSelector;

            if (!Element.prototype.closest)
                Element.prototype.closest = function (s) {
                    var el = this;
                    if (!document.documentElement.contains(el)) return null;
                    do {
                        if (el.matches(s)) return el;
                        el = el.parentElement || el.parentNode;
                    } while (el !== null && el.nodeType === 1);
                    return null;
                };
    </script>
    <script>
        let title = '<h1 class="article-main__title"> < ruby > 暑 < rt > あつ</rt></ruby > いドイツでビールが < ruby > 売 < rt > う</rt ></ruby > れて < ruby > 瓶 < rt > びん</rt ></ruby > が < ruby > 足 < rt > た</rt ></ruby > りなくなっている </h1 >';
        let input = '<div class="article-main__body article-body" id="js-article-body"> <p><span class="colorL">ドイツ</span>では<ruby>厳<rt>きび</rt></ruby>しい<ruby>暑<rt>あつ</rt></ruby>さが<ruby>続<rt>つづ</rt></ruby>いていて、<ruby>山<rt>やま</rt></ruby>が<ruby>火事<rt>かじ</rt></ruby>になったり、<ruby>雨<rt>あめ</rt></ruby>が<ruby>少<rt>すく</rt></ruby>なくて<a href="javascript:void(0)" class="dicWin" id="id-0003"><ruby><span class="under">畑</span><rt>はたけ</rt></ruby></a>に<ruby>水<rt>みず</rt></ruby>が<ruby>足<rt>た</rt></ruby>りなくなったりしています。<span class="colorL">ハノーバー</span>にある<ruby>空港<rt>くうこう</rt></ruby>では、<a href="javascript:void(0)" class="dicWin" id="id-0004"><ruby><span class="under">滑走路</span><rt>かっそうろ</rt></ruby></a>の<a href="javascript:void(0)" class="dicWin" id="id-0005"><ruby><span class="under">表面</span><rt>ひょうめん</rt></ruby></a>が<a href="javascript:void(0)" class="dicWin" id="id-0006"><span class="under">はがれ</span></a>て、しばらく<ruby>空港<rt>くうこう</rt></ruby>を<ruby>使<rt>つか</rt></ruby>うことができなくなりました。</p> <p><a href="javascript:void(0)" class="dicWin" id="id-0000"><span class="under">ビール</span></a>をよく<ruby>飲<rt>の</rt></ruby>む<span class="colorL">ドイツ</span>の<ruby>人<rt>ひと</rt></ruby>は、<ruby>今年<rt>ことし</rt></ruby>の<ruby>夏<rt>なつ</rt></ruby>はいつもよりたくさん<a href="javascript:void(0)" class="dicWin" id="id-0000"><span class="under">ビール</span></a>を<ruby>飲<rt>の</rt></ruby>んでいます。</p> <p><span class="colorL">ドイツ</span>では、<a href="javascript:void(0)" class="dicWin" id="id-0000"><span class="under">ビール</span></a>の<a href="javascript:void(0)" class="dicWin" id="id-0002"><ruby><span class="under">瓶</span><rt>びん</rt></ruby></a>や<a href="javascript:void(0)" class="dicWin" id="id-0007"><span class="under">ケース</span></a>を<a href="javascript:void(0)" class="dicWin" id="id-0008"><span class="under">リサイクル</span></a>していて、<a href="javascript:void(0)" class="dicWin" id="id-0000"><span class="under">ビール</span></a>を<ruby>飲<rt>の</rt></ruby>んだあと<a href="javascript:void(0)" class="dicWin" id="id-0002"><ruby><span class="under">瓶</span><rt>びん</rt></ruby></a>を<ruby>店<rt>みせ</rt></ruby>などに<a href="javascript:void(0)" class="dicWin" id="id-0009"><ruby><span class="under">戻</span><rt>もど</rt></ruby><span class="under">す</span></a>と、お<ruby>金<rt>かね</rt></ruby>が<a href="javascript:void(0)" class="dicWin" id="id-0010"><ruby><span class="under">返</span><rt>かえ</rt></ruby><span class="under">っ</span></a>てきます。しかし、<a href="javascript:void(0)" class="dicWin" id="id-0000"><span class="under">ビール</span></a>がどんどん<a href="javascript:void(0)" class="dicWin" id="id-0001"><ruby><span class="under">売</span><rt>う</rt></ruby><span class="under">れ</span></a>ているため、<a href="javascript:void(0)" class="dicWin" id="id-0002"><ruby><span class="under">瓶</span><rt>びん</rt></ruby></a>などが<ruby>足<rt>た</rt></ruby>りなくなっています。</p> <p><a href="javascript:void(0)" class="dicWin" id="id-0000"><span class="under">ビール</span></a>の<ruby>会社<rt>かいしゃ</rt></ruby>は、<ruby>飲<rt>の</rt></ruby>んだあとは<a href="javascript:void(0)" class="dicWin" id="id-0002"><ruby><span class="under">瓶</span><rt>びん</rt></ruby></a>や<a href="javascript:void(0)" class="dicWin" id="id-0007"><span class="under">ケース</span></a>を<ruby>早<rt>はや</rt></ruby>く<a href="javascript:void(0)" class="dicWin" id="id-0011"><ruby><span class="under">戻</span><rt>もど</rt></ruby><span class="under">し</span></a>てほしいと<ruby>言<rt>い</rt></ruby>っています。</p> <p></p> <p></p> </div>';
        const parser = function (input) {
            let output = [], curr_index = 0, sentences = [];

            while (curr_index != -1) {
                curr_index = input.indexOf('。')
                if (curr_index != -1) {
                    sentences.push(input.substring(0, curr_index + 1).trim())
                    input = input.substring(curr_index + 1)
                } else {
                    sentences[sentences.length - 1] += input;
                }
            }

            sentences.forEach((sentence) => {
                output.push(constructSentence(sentence));
            })


            function constructSentence(rawSen) {
                let result = {}
                result.content = rawSen.replace(/<rt>[^<]*?<\/rt>|\s/g, '').replace(/<[^>]*?>/g, '');
                result.words = constructWords(rawSen);

                return result;
            }

            function constructWords(rawSen) {
                let words = []

                rawSen = rawSen.replace(/(<\/[^>]*?>|^)([^<\/>]+?)(<[^>]*?>|$)/g, function (match, p1, p2, p3) {
                    return `${p1}<span>${p2}</span>${p3}`;
                })

                rawSen.replace(/<span[^>]*?>(.*?)<\/span>|<ruby>(.*?)<rt>(.*?)<\/rt><\/ruby>/g, function (match, p1, p2, p3) {
                    if (match.indexOf('<span') === 0) {
                        words.push({
                            "moji": p1.replace(/<[^>]*?>|\s/g, ''),
                            "furigana": ""
                        })
                    } else {
                        words.push({
                            "moji": p2.replace(/<[^>]*?>|\s/g, ''),
                            "furigana": p3.replace(/<[^>]*?>|\s/g, '')
                        })
                    }
                    return '';
                });

                return words;

            }

            return output;
        }

        const builder = function (sentences) {
            let html = '', str, id = 0;
            sentences.forEach(sentence => {
                str = ''
                sentence.words.forEach(word => {
                    if (word.furigana) {
                        str += `<ruby>${word.moji}<rt>${word.furigana}</rt></ruby>`
                    } else {
                        str += `<span>${word.moji}</span>`
                    }
                })
                html += `<p class="sentences" id=${id++}>${str}</p>`;
            })

            return html;
        }
        let output = parser(input);
        document.querySelector('#app').innerHTML = builder(output);

        document.querySelector('#app').addEventListener('click', function(event){
            let target = event.target.closest('.sentences');
            if(target){
                var speechSU = new window.SpeechSynthesisUtterance(output[target.id].content);
                speechSU.lang = 'ja-JP';
                speechSU.rate = 0.8;
                window.speechSynthesis.speak(speechSU);
            }
        })

    </script>
</body>
</html>